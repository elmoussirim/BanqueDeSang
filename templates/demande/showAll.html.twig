{% extends 'base.html.twig' %}


{% block body %}


{% if not app.user %}
<p>Connectez-vous pour effectuer cette opération</p>
{% elseif is_granted('ROLE_INFSER') or is_granted('ROLE_MEDSER') or  app.user.poste == "Technicien de laboratoire"  %}
                            <div class="panel panel-default">
                                <div class="panel-heading ui-draggable-handle">
                                    <h3 class="panel-title">Les demandes</h3>
                                    <div class="pull-right">
                                    </div>
                                </div>
                                <div id="DataTables_Table_1_wrapper" class="dataTables_wrapper no-footer"><table class="table datatable_simple dataTable no-footer" id="DataTables_Table_1" role="grid"> 
                                    <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper no-footer">                               
                                        <form role="form"  method="request" action="{{ path('search_demande') }}">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="search" placeholder="Nom malade ?? (ou) Cin malade?? (ou) service ?? (ou) N° demande??">
                                                    <span class="input-group-addon" type="submit">chercher</span>
                                                </div>
                                        </form>
                                    </div>                                 
                                </div>

                                <div class="panel-body">
                                    <table id="customers" class="table table-striped">
                                
                                        <thead>
                                            <tr>
                       
                                                <th>N°demande</th>
                                                <th>Date</th>
                                                <th>Avant</th>
                                                <th>Type</th>
                                                <th>N° poches </th>
                                                <th>GS</th>
                                                <th>Sérum</th>
                                                <th>Malade</th>
                                                <th>Service</th>
                                                <th>Inférmiere</th>
                                                <th>Médecin</th>
                                                <th>Actions</th>

                                            </tr>
                                        </thead>
                                        <tbody>

                                            {% for demande in demandes %}
                                                {% if app.user.poste != "Technicien de laboratoire" %} 
                                                    {% if demande.reponse == " " %}
                                                        <tr class="text-danger">
                                                    {% else %}
                                                        <tr class="text-primary">
                                                    {% endif %}
                                                        <th scope="row">{{ demande.Id }}</th>
                                                        <td>{{ demande.DateDemande|date ('d/m/y à H:i') }}</td>
                                                        <td>{{ demande.DateUtilisation|date ('d/m/y à H:i') }}</td>
                                                        <td>{{ demande.Type }}</td>
                                                        <td>{{ demande.NombrePoche }}</td>
                                                        <td>{{ demande.GS }}</td>
                                                        <td>{{ demande.serum }}</td>
                                                        {% for malade in malades %}
                                                            {% if malade == demande.Malade %}
                                                                <td>{{ malade.Malade }}: {{ malade.NumeroCin }}</td>
                                                            {% endif %}
                                                        
                                                            {% for service in services %}
                                                                {% if service.id == malade.service.id %}
                                                                    <td>{{ service.NomService }}</td>
                                                                {% endif %}
                                                            {% endfor %}
                                                        
                                                    {% for user in users %}
                                                        {% if user == demande.User1 %}
                                                            <td>{{ user.NUMCIN }}: {{ user.username }}</td>
                                                        {% elseif user== demande.User2 %}
                                                            <td>{{ user.NUMCIN }}: {{ user.username }}</td>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if demande.User2 == null %} 
                                                        <td></td>   
                                                    {% endif %}
                                                    {% if is_granted('ROLE_INFSER') and demande.reponse == " " %}
                                                    
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='/demande/{{ demande.id }}/delete'">Supprimer</button></td>
                                                    {% elseif is_granted('ROLE_INFSER') and demande.reponse != " " %}
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='/demande/{{ demande.id }}/show'">Voir</button></td>
                                                    {% elseif app.user.poste == "Médecin de service" and  demande.User2 == null and demande.reponse == " " %}
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='/demande/{{ demande.id }}/valide'">Valider</button></td>
                                                    {% elseif app.user.poste == "Médecin de service" and  demande.User2 != null and demande.reponse != " " %}
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='/demande/{{ demande.id }}/feedback'">Commenter</button></td>
                                                    {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                {% if app.user.poste == "Technicien de laboratoire" and  demande.User2 != null %} 
                                                    {% if demande.reponse == " " %}
                                                        <tr>
                                                    {% else %}
                                                        <tr class="text-primary">
                                                    {% endif %}
                                                        <th scope="row">{{ demande.Id }}</th>
                                                        <td>{{ demande.DateDemande|date ('d/m/y à H:i') }}</td>

                                                        <td>{{ demande.DateUtilisation|date ('d/m/y à H:i') }}</td>

                                                        <td>{{ demande.Type }}</td>
                                                        <td>{{ demande.NombrePoche }}</td>
                                                        <td>{{ demande.GS }}</td>
                                                        <td>{{ demande.serum }}</td>
                                                        {% for malade in malades %}

                                                            {% if malade == demande.Malade %}
                                                                <td>{{ malade.Malade }}: {{ malade.NumeroCin }}</td>
                                                            {% endif %}
                                                            
                                                            {% for service in services %}
                                                                {% if service.id == malade.service.id %}
                                                                    <td>{{ service.NomService }}</td>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endfor %}
                                                    {% for user in users %}
                                                        {% if user == demande.User1 %}
                                                            <td>{{ user.NUMCIN }}: {{ user.username }}</td>
                                                        {% elseif user == demande.User2 %}
                                                            <td>{{ user.NUMCIN }}: {{ user.username }}</td>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if demande.User2 == null %} 
                                                        <td></td>   
                                                    {% endif %}
                                                    {% if demande.reponse == " " %}
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='demande/{{ demande.id }}/reponse'">Répondre</button></td>
                                                    {% else %}
                                                        <td><button type="button" class="btn btn-warning" onclick="window.location.href='/demande/{{ demande.id }}/show'">Voir</button></td>
                                                    {% endif %}
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}

                                        </tbody>
                                </table>
                               </div>
       
{% else %}
<p>Vos droits d'utilisateur sont insuffisants pour l'opération demandée!</p>
{% endif %}
{% endblock %}